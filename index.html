<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Bootstrap 5 cdn -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/css/bootstrap.min.css" integrity="sha384-/Y6pD6FV/Vv2HJnA6t+vslU6fwYXjCFtcEpHbNJ0lyAFsXTsjBbfaDjzALeQsN6M" crossorigin="anonymous">
  <title>Document</title>

  <!-- jQuery -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

  <!-- Downloadjs cdn -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/downloadjs/1.4.8/download.min.js" integrity="sha512-WiGQZv8WpmQVRUFXZywo7pHIO0G/o3RyiAJZj8YXNN4AV7ReR1RYWVmZJ6y3H06blPcjJmG/sBpOVZjTSFFlzQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>
<body>
  <!-- Bootstrap template with text field and button -->
  <!-- Website name -->
  <div class="container" style="margin-top: 30px">
    <div class="row">
      <div class="col-md-4">
        <h1 class='display-4'>Stock Bot Web</h1>
      </div>
    </div>
  </div>


  <!-- Select ticker symbol -->
  <div class="container">
    <div class="row">
      <div class="col-md-4">
        <form class="form-horizontal" onsubmit="return false">
          <div class="form-group">
            <label for="ticker">Comma-seperated Ticker Symbol(s)</label>
            <!-- Capitalize input -->
            <input style="max-width: 100%;" type="text" class="form-control" id="ticker" placeholder="e.g. TSLA, MSFT" onkeyup="this.value = this.value.toUpperCase().split(/\W+/gi).join(', ').trim(); updateBadges()">
            
            <!-- Display bootstrap badges with ticker symbol -->
            <div id="ticker-badges" class="badge-group">
              <span id="ticker-badge" class="badge badge-pill badge-warning">None</span>
            </div>
            <script>
              function updateBadges() {

                var ticker_badges = document.getElementById('ticker-badges');
                ticker_badges.innerHTML = '';
                let values = document.getElementById('ticker').value.split(', ');
                for (let i = 0; i < values.length; i++) {
                  // Add a badge for each ticker symbol
                  var ticker_badge = document.createElement('span');
                  ticker_badge.innerHTML = values[i];
                  ticker_badge.className = "badge badge-secondary";
                  ticker_badge.style.margin = "2px"
                  ticker_badges.appendChild(ticker_badge);
                }

              }
            </script>
          </div>
        </form>
        <!-- Submit button without page refresh -->
        <button type="button" class="btn btn-primary" onclick="submit();return false">Submit</button>
      </div>
    </div>

    <hr/>
    <div class="row">
      <!-- Status message -->
      <div class="col-md-4">
        <span id='status'>Submit request above</span>
      </div>
    </div>
  </div>


</body>

  
</body>
<script>
var baseUrl = 'https://frozen-meadow-29453.herokuapp.com'
var loading = false
var secondsRemaining = 0

setInterval(function() {
  // Update status message
  if (!loading) {
    return
  }
  var timeLeft = document.getElementById('seconds-remaining');
  if (timeLeft) {
    timeLeft.innerHTML = secondsRemaining;
    secondsRemaining -= 1;
  }
}, 1000);


function submit() {
  if (loading) {
    alert("Request already sent. Please wait for request to finish or reload this page.")
    return
  }


  // Set status to loading
  document.getElementById('status').innerHTML = 'Loading...';

  // Get the ticker symbols
  var tickers = document.getElementById('ticker').value.split(', ');
  if (tickers.length == 0) {
    alert("Please enter at least one ticker symbol.");
    return
  }

  loading = true

  // Submit API request to my server
  setTimeout(() => {
    if (!loading) return
    fetch(baseUrl + '/stonkshowlong')
      .then(function(response) {
        return response.text();
      })
      .then(function(seconds) {
        console.log('received seconds ' + seconds);
        if (loading) {
          secondsRemaining = parseInt(seconds) - 5 // Because I send this request 5 seconds after
                // Set status to time remaining
      let timeRemainingDialog = `<div class="alert alert-secondary" role="alert">
        <strong id="seconds-remaining">${seconds}</strong> seconds remaining
      </div>`;
      document.getElementById('status').innerHTML = timeRemainingDialog;
        }
      })
    }, 1000 * 5)

    
    fetchDownload()
    let myInterval = setInterval(() => {
      if (!loading) {
        clearInterval(myInterval);
      }
      fetchDownload()
    }, 25); // Heroku allows re-submitting requests every 30 seconds

}

function fetchDownload() {
  fetch(baseUrl + '/stonks', {
    method: 'POST',
    headers: {
      'Accept': 'application/json',
      'Content-Type': 'application/json',
      'cors': 'true'
    },
    body: JSON.stringify({
      tickers: tickers,
      passcode: 'sourpatchkids27'
    })
  })
  .then((response) => response.blob())
    .then((blob) => {
      // Get current time in readable format
      let currentDate = new Date().toLocaleDateString()

      download(blob, 'Options_' + currentDate + '.xlsx');

      // Set status to done
      let successBootstrapDialog = `<div class="alert alert-success" role="alert">
        <strong>Success!</strong> Your options file has been downloaded.
      </div>`;
      document.getElementById('status').innerHTML = successBootstrapDialog;
      loading= false;
    });

  // Clear the ticker symbol input
  document.getElementById('ticker').value = '';
  updateBadges()

}
</script>


</html>